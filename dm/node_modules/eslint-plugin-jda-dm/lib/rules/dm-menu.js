/**
 * @fileoverview Warns about using code that isn't safe with the new REFS
 * menu upgrade.
 * @author Ayush Chinnan (Refered from WMD wm-menu.js)
 */
'use strict';

var CallExpression = require('../CallExpression.js'),
    ExtClass = require('../ExtClass.js');

//------------------------------------------------------------------------------
// Rule Definition
//------------------------------------------------------------------------------

module.exports = function(context) {

    var classes = [
        'RP.chrome.task.TaskWidget',
        'RP.chrome.dialog.ChangePassword',
        'RP.chrome.dialog.ChangeSiteWindow',
        'RP.chrome.dialog.ExternalAuthenticationExpiredDialog',
        'RP.chrome.dialog.InactivityWarningDialog',
        'RP.chrome.dialog.PageInactivityChecker',
        'RP.chrome.dialog.SessionExpiredDialog',
        'RP.chrome.dialog.UnstableEnvironmentWindow',
        'RP.chrome.registry.Component',
        'RP.chrome.registry.CustomPage',
        'RP.chrome.registry.Module',
        'RP.chrome.registry.Taskflow',
        'RP.chrome.registry.Task',
        'RP.chrome.registry.TaskWidget',
        'RP.chrome.search.SearchAPIPanel',
        'RP.chrome.search.SearchComboBox',
        'RP.chrome.search.SearchResultPanel',
        'RP.chrome.search.model.APIField',
        'RP.chrome.search.model.APIResource',
        'RP.chrome.search.model.Category',
        'RP.chrome.search.model.History',
        'RP.chrome.search.model.ResultFlow',
        'RP.chrome.task.TaskBar',
        'RP.chrome.task.TaskWidget',
        'RP.chrome.taskflow.TaskflowToolbar',
        'RP.chrome.taskflow.TaskflowViewContainer',
        'RP.chrome.taskflow.TaskflowWidget',
        'RP.core.PageContext',
        'RP.core.SessionSecurity',
        'RP.logout.LogoutForm',
        'RP.navigation.PageContext',
        'RP.navigation.TaskContext',
        'RP.navigation.Taskflow',
        'RP.taskflow.ExternalAppTaskForm',
        'RP.taskflow.ExternalAppWidget',
        'RP.taskflow.TaskContext',
        'RP.upb.AppEvents',
        'RP.upb.PageBootstrapper',
        'RP.util.Helpers'
    ];

    var expressions = [
        'RP.chrome.registry.Taskflow.get',
        'RP.navigation.NavigationManager.getLocation',
        'RP.navigation.NavigationManager.getLink',
        'RP.navigation.NavigationManager.navigate',
        'RP.getTaskflowFrame',
        'RP.getWidgetXType',
        'RP.registerWidget'
    ];

    //--------------------------------------------------------------------------
    // Helpers
    //--------------------------------------------------------------------------

    function extendsDeprecatedClass(callExpression) {
        if (callExpression.toString() !== 'Ext.define') {
            return false;
        }

        var extClass = new ExtClass(callExpression);

        return classes.indexOf(extClass.getConfig('extend')) > -1;
    }

    function isExpressionDeprecated(callExpression) {
        return expressions.indexOf(callExpression.toString()) > -1;
    }

    function checkCallExpression(node) {
        var callExpression = new CallExpression(node);

        if (isExpressionDeprecated(callExpression)) {
            context.report(node, 'This function is not menu upgrade safe');
        } else if (extendsDeprecatedClass(callExpression)) {
            context.report(node, 'This class is not menu upgrade safe');
        }
    }

    //--------------------------------------------------------------------------
    // Public
    //--------------------------------------------------------------------------

    return {
        CallExpression: checkCallExpression
    };
};
